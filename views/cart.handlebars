<div class="cart-page">
    <h2>Carrito de Compras</h2>

    {{#if cart}}
    <div class="cart-container">
        {{#if cart.products}}
        {{#if cart.products.length}}
        <div class="cart-items">
            {{#each cart.products}}
            <div class="cart-item">
                <div class="item-info">
                    {{#if product}}
                    <h3>{{product.title}}</h3>
                    <p class="item-id">ID: {{product._id}}</p>
                    <p class="item-code">Código: {{product.code}}</p>
                    {{#if product.category}}
                    <p class="item-category">Categoría: {{product.category}}</p>
                    {{/if}}
                    {{#if product.description}}
                    <p class="item-description">{{product.description}}</p>
                    {{/if}}
                    {{else}}
                    <p>Producto no encontrado</p>
                    {{/if}}
                </div>
                <div class="item-details">
                    {{#if product}}
                    <div class="item-price">
                        <strong>Precio unitario:</strong> ${{product.price}}
                    </div>
                    <div class="item-quantity">
                        <strong>Cantidad:</strong> {{quantity}}
                    </div>
                    <div class="item-total">
                        <strong>Total:</strong> $<span class="item-subtotal"
                            data-price="{{#if product}}{{product.price}}{{else}}0{{/if}}"
                            data-quantity="{{quantity}}">0</span>
                    </div>
                    {{/if}}
                </div>
                {{#if product}}
                <div class="item-actions">
                    <button onclick="removeFromCart('{{../cart._id}}', '{{product._id}}')" class="btn btn-remove">
                        Eliminar
                    </button>
                </div>
                {{/if}}
            </div>
            {{/each}}
        </div>

        <div class="cart-summary">
            <div class="summary-total">
                <h3>Total del Carrito</h3>
                <p class="total-amount">$<span id="cart-total">0</span></p>
            </div>
            <div class="summary-actions">
                <button onclick="clearCart('{{cart._id}}')" class="btn btn-clear">Vaciar Carrito</button>
            </div>
        </div>
        {{else}}
        <div class="empty-cart">
            <p>El carrito está vacío</p>
            <a href="/products" class="btn btn-primary">Ver Productos</a>
        </div>
        {{/if}}
        {{else}}
        <div class="empty-cart">
            <p>El carrito está vacío</p>
            <a href="/products" class="btn btn-primary">Ver Productos</a>
        </div>
        {{/if}}
    </div>
    {{else}}
    <div class="error-message">
        <p>Carrito no encontrado</p>
        <a href="/products" class="btn btn-primary">Volver a productos</a>
    </div>
    {{/if}}
</div>

<script>
    // Calcular total del carrito al cargar la página
    document.addEventListener('DOMContentLoaded', function () {
        const subtotals = document.querySelectorAll('.item-subtotal');
        let total = 0;
        subtotals.forEach(subtotal => {
            const price = parseFloat(subtotal.getAttribute('data-price')) || 0;
            const quantity = parseFloat(subtotal.getAttribute('data-quantity')) || 0;
            const subtotalValue = price * quantity;
            subtotal.textContent = subtotalValue.toFixed(2);
            total += subtotalValue;
        });
        const totalElement = document.getElementById('cart-total');
        if (totalElement) {
            totalElement.textContent = total.toFixed(2);
        }
    });

    async function removeFromCart(cartId, productId) {
        try {
            const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                location.reload();
            } else {
                alert('Error al eliminar producto del carrito');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al eliminar producto del carrito');
        }
    }

    async function clearCart(cartId) {
        if (!confirm('¿Está seguro de que desea vaciar el carrito?')) {
            return;
        }

        try {
            const response = await fetch(`/api/carts/${cartId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                location.reload();
            } else {
                alert('Error al vaciar el carrito');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al vaciar el carrito');
        }
    }
</script>

<style>
    .cart-page {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .cart-container {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .cart-items {
        margin-bottom: 30px;
    }

    .cart-item {
        display: grid;
        grid-template-columns: 2fr 1fr auto;
        gap: 20px;
        padding: 20px;
        border-bottom: 1px solid #eee;
        align-items: start;
    }

    .cart-item:last-child {
        border-bottom: none;
    }

    .item-info h3 {
        color: #333;
        margin-bottom: 10px;
        font-size: 20px;
    }

    .item-id {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
    }

    .item-code {
        color: #555;
        margin-bottom: 5px;
    }

    .item-category {
        color: #555;
        margin-bottom: 5px;
    }

    .item-description {
        color: #777;
        font-size: 14px;
        margin-top: 10px;
        line-height: 1.5;
    }

    .item-details {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .item-price,
    .item-quantity,
    .item-total {
        color: #333;
    }

    .item-total {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
    }

    .item-actions {
        display: flex;
        align-items: center;
    }

    .cart-summary {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .summary-total h3 {
        margin-bottom: 10px;
        color: #333;
    }

    .total-amount {
        font-size: 32px;
        font-weight: bold;
        color: #27ae60;
    }

    .empty-cart {
        text-align: center;
        padding: 60px;
    }

    .empty-cart p {
        font-size: 24px;
        color: #666;
        margin-bottom: 20px;
    }

    .error-message {
        text-align: center;
        padding: 60px;
        background: white;
        border-radius: 8px;
    }

    .error-message p {
        font-size: 24px;
        color: #e74c3c;
        margin-bottom: 20px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        font-size: 14px;
        transition: background-color 0.2s;
    }

    .btn-remove {
        background-color: #e74c3c;
        color: white;
    }

    .btn-remove:hover {
        background-color: #c0392b;
    }

    .btn-clear {
        background-color: #e67e22;
        color: white;
    }

    .btn-clear:hover {
        background-color: #d35400;
    }

    .btn-primary {
        background-color: #3498db;
        color: white;
    }

    .btn-primary:hover {
        background-color: #2980b9;
    }

    @media (max-width: 768px) {
        .cart-item {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .cart-summary {
            flex-direction: column;
            gap: 20px;
        }
    }
</style>