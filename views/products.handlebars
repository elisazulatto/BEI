<div class="products-page">
    <div class="page-header">
        <h2>Productos</h2>
        <a href="#" id="cart-link" class="btn btn-cart-link" style="display: none;">Ver Carrito</a>
    </div>

    {{!-- Filtros y ordenamiento --}}
    <div class="filters-container">
        <form method="GET" action="/products" class="filters-form">
            <div class="filter-group">
                <label for="query">Buscar por categoría o disponibilidad:</label>
                <input type="text" id="query" name="query" value="{{query}}" placeholder="Ej: Electrónica, disponible">
            </div>
            <div class="filter-group">
                <label for="sort">Ordenar por precio:</label>
                <select id="sort" name="sort">
                    <option value="">Sin ordenar</option>
                    <option value="asc" {{#isEqual sort "asc" }}selected{{/isEqual}}>Menor a Mayor</option>
                    <option value="desc" {{#isEqual sort "desc" }}selected{{/isEqual}}>Mayor a Menor</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="limit">Productos por página:</label>
                <select id="limit" name="limit">
                    <option value="5" {{#if pagination}}{{#isEqual pagination.limit 5}}selected{{/isEqual}}{{/if}}>5
                    </option>
                    <option value="10" {{#if pagination}}{{#isEqual pagination.limit 10}}selected{{/isEqual}}{{/if}}>10
                    </option>
                    <option value="20" {{#if pagination}}{{#isEqual pagination.limit 20}}selected{{/isEqual}}{{/if}}>20
                    </option>
                </select>
            </div>
            <button type="submit">Filtrar</button>
        </form>
    </div>

    {{!-- Lista de productos --}}
    {{#if products}}
    <div class="products-container">
        {{#each products}}
        <div class="product-card">
            <h3>{{title}}</h3>
            <p class="product-id"><strong>ID:</strong> {{_id}}</p>
            {{#if description}}
            <p class="product-description">{{description}}</p>
            {{/if}}
            <p><strong>Código:</strong> {{code}}</p>
            <p class="product-price"><strong>Precio:</strong> ${{price}}</p>
            <p><strong>Estado:</strong> {{#if status}}<span class="status-available">Disponible</span>{{else}}<span
                    class="status-unavailable">No disponible</span>{{/if}}</p>
            {{#if stock}}
            <p><strong>Stock:</strong> {{stock}}</p>
            {{/if}}
            {{#if category}}
            <p><strong>Categoría:</strong> {{category}}</p>
            {{/if}}
            {{#if thumbnails}}
            {{#if thumbnails.length}}
            <div class="thumbnails">
                {{#each thumbnails}}
                <img src="{{this}}" alt="Thumbnail" class="thumbnail-img">
                {{/each}}
            </div>
            {{/if}}
            {{/if}}
            <div class="product-actions">
                <a href="/products/{{_id}}" class="btn btn-details">Ver Detalles</a>
                <button onclick="addToCart('{{_id}}')" class="btn btn-add-cart">Agregar al Carrito</button>
            </div>
        </div>
        {{/each}}
    </div>
    {{else}}
    <p class="no-products">No hay productos disponibles.</p>
    {{/if}}

    {{!-- Paginación --}}
    {{#if pagination}}
    <div class="pagination-container">
        <div class="pagination-info">
            <p>Página {{pagination.page}} de {{pagination.totalPages}}</p>
        </div>
        <div class="pagination-buttons">
            {{#if pagination.hasPrevPage}}
            <a href="{{pagination.prevLink}}" class="btn btn-pagination">← Anterior</a>
            {{else}}
            <span class="btn btn-pagination disabled">← Anterior</span>
            {{/if}}

            {{#if pagination.hasNextPage}}
            <a href="{{pagination.nextLink}}" class="btn btn-pagination">Siguiente →</a>
            {{else}}
            <span class="btn btn-pagination disabled">Siguiente →</span>
            {{/if}}
        </div>
    </div>
    {{/if}}
</div>

<script>
    // Mostrar link al carrito si existe
    document.addEventListener('DOMContentLoaded', function () {
        const cartId = localStorage.getItem('cartId');
        if (cartId) {
            const cartLink = document.getElementById('cart-link');
            if (cartLink) {
                cartLink.href = `/carts/${cartId}`;
                cartLink.style.display = 'inline-block';
            }
        }
    });

    // Función para agregar producto al carrito
    async function addToCart(productId) {
        try {
            // Primero necesitamos obtener o crear un carrito
            // Por simplicidad, usaremos el primer carrito disponible o crearemos uno nuevo
            let cartId = localStorage.getItem('cartId');

            if (!cartId) {
                // Crear un nuevo carrito
                const response = await fetch('/api/carts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                cartId = data.payload._id;
                localStorage.setItem('cartId', cartId);
                
                // Actualizar links del carrito
                if (typeof updateCartNavLink === 'function') {
                    updateCartNavLink();
                }
                const cartLink = document.getElementById('cart-link');
                if (cartLink) {
                    cartLink.href = `/carts/${cartId}`;
                    cartLink.style.display = 'inline-block';
                }
            }

            // Agregar producto al carrito
            const addResponse = await fetch(`/api/carts/${cartId}/product/${productId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (addResponse.ok) {
                alert('Producto agregado al carrito exitosamente');
            } else {
                alert('Error al agregar producto al carrito');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al agregar producto al carrito');
        }
    }
</script>

<style>
    .products-page {
        padding: 20px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .btn-cart-link {
        background-color: #9b59b6;
        color: white;
    }

    .btn-cart-link:hover {
        background-color: #8e44ad;
    }

    .filters-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .filters-form {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        font-weight: bold;
        font-size: 14px;
    }

    .filter-group input,
    .filter-group select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .products-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .product-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .product-card h3 {
        color: #333;
        margin-bottom: 10px;
        font-size: 20px;
    }

    .product-id {
        font-size: 12px;
        color: #666;
        margin-bottom: 10px;
    }

    .product-description {
        color: #555;
        margin-bottom: 10px;
        line-height: 1.5;
    }

    .product-price {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
        margin: 10px 0;
    }

    .status-available {
        color: green;
        font-weight: bold;
    }

    .status-unavailable {
        color: red;
        font-weight: bold;
    }

    .thumbnails {
        display: flex;
        gap: 10px;
        margin: 10px 0;
        flex-wrap: wrap;
    }

    .thumbnail-img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #ddd;
    }

    .product-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        font-size: 14px;
        transition: background-color 0.2s;
    }

    .btn-details {
        background-color: #3498db;
        color: white;
    }

    .btn-details:hover {
        background-color: #2980b9;
    }

    .btn-add-cart {
        background-color: #27ae60;
        color: white;
    }

    .btn-add-cart:hover {
        background-color: #229954;
    }

    .pagination-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .pagination-info {
        font-weight: bold;
    }

    .pagination-buttons {
        display: flex;
        gap: 10px;
    }

    .btn-pagination {
        background-color: #34495e;
        color: white;
    }

    .btn-pagination:hover {
        background-color: #2c3e50;
    }

    .btn-pagination.disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .no-products {
        text-align: center;
        padding: 40px;
        font-size: 18px;
        color: #666;
    }
</style>